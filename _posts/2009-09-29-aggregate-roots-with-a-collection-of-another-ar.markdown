---
layout: post
title: "Aggregate Roots with a collection of another AR"
date: 2009-09-29 23:43:00
comments: true
categories: 
---

<p>I have been wondering whether an aggregate root should ever contain a collection of another aggregate root.&nbsp; Back to the Customer.&nbsp; Is it OK to have a collection of Orders?&nbsp; One could argue that a customer may have many thousands of orders after some time so it would be impractical.&nbsp; However, such a collection (in the domain) would mean that the customer only has a collection of the <em>open</em> orders.&nbsp; So in a real sense this list should never be all that big.&nbsp; Using CQS one may even remove the completed orders from the domain store.</p>
<p>Even so, what purpose would this collection serve.&nbsp; It seems, to me anyway, that the only time such a collection of ARs should be considered is when it falls within the <em>consistency boundary</em> of the containing AR.&nbsp; So, as per DDD, an aggregate root represents a consistency boundary.&nbsp; For example, an order with its contained order items needs to be consistent; and it seems rather obvious.</p>
<p>Then one comes across issues such as: "A <em>bronze</em> customer may not have more than 2 open orders at any one time and with a total of no more than $10,000".&nbsp; Similar rules apply to other customer types.&nbsp; A typical reaction is to have a reference to the customer in an order to get the type (bronze, etc.) and to be able to ask the OrderRepository for the total of all open orders for the customer.&nbsp; That is <em>one</em> way to do it, Iguess.</p>
<p>However, suddenly the <em>consistency boundary</em> has moved.&nbsp; It is now around the customer.&nbsp; This means that one would no longer add an order willy-nilly but rather add the order to the customer.&nbsp; So <em><strong>now</strong></em> we need an Orders collection for the customer.&nbsp; This does not mean that an Order is no longer an aggregate.&nbsp; This is also why some people reckon that the aggregate root changes depending on the use case.&nbsp; It is possible that when applying an 'apply order discount' task that the order stays the AR since it doesn't affect the overall collection of orders within the customer boundary.&nbsp; It also does not mean that we will not have an OrderRepository.&nbsp; But it does mean that when applying the CreateOrderCommand in our domain that the customer will be loaded, the newly created order will be added to the customer, the consistency checked and if OK the order will be persisted using the OrderRepository.</p>